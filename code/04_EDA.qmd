---
title: "Exploratory Data Analysis"
format: html
---

```{r}

#| output: FALSE

library(dplyr)
library(mixOmics)
library(wesanderson)

```

# Load Data
```{r}

source("functions/Load_Normalized_Expression.R")
normalized_data = load_normalized_expression("../outputs/normalized_expression.csv")
rm(load_normalized_expression)

```


# Color palette
```{r}

palette_discrete = wes_palette("Darjeeling1", 5, type = "discrete")
wes_palette("Darjeeling1", 5, type = "discrete")

palette_continuous = wes_palette("Zissou1", 100, type = "continuous")
wes_palette("Zissou1", 100, type = "continuous")

```


# PCA
```{r}

pca_results = prcomp(normalized_data)

rownames(sample_metadata) = sample_metadata$sample_id

pca_results$x = merge(pca_results$x, sample_metadata, by = "row.names")

ggplot(as.data.frame(pca_results$x), aes(x = PC1, y = PC2, label = Row.names, color = tumor_descriptor)) +
    geom_point() +
    geom_label(size = 2) +
    scale_color_manual(values = palette_discrete[c(5,1)]) +
    theme_classic()

ggplot(as.data.frame(pca_results$x), aes(x = PC1, y = PC2, color = tissue_rollup)) +
    geom_point() +
    scale_color_manual(values = palette_discrete) +
    theme_classic()

ggplot(as.data.frame(pca_results$x), aes(x = PC1, y = PC2, color = ajcc_pathologic_stage)) +
    geom_point() +
    scale_color_manual(values = wes_palette("Zissou1", 13, type = "continuous")) +
    theme_classic()

```

# Stage vs. Primary/Met
```{r}

table(sample_metadata$tumor_descriptor, sample_metadata$ajcc_pathologic_stage)

```

# Stage vs Overall Survival
```{r}

#Simplify staging
sample_metadata = sample_metadata |> 
    mutate(stage = as.factor(case_when(
        ajcc_pathologic_stage == "Stage 0" ~ "0",
        ajcc_pathologic_stage == "Stage I" ~ "1",
        ajcc_pathologic_stage == "Stage IA" ~ "1",
        ajcc_pathologic_stage == "Stage IB" ~ "1",
        ajcc_pathologic_stage == "Stage II" ~ "2",
        ajcc_pathologic_stage == "Stage IIA" ~ "2",
        ajcc_pathologic_stage == "Stage IIB" ~ "2",
        ajcc_pathologic_stage == "Stage IIC" ~ "2",
        ajcc_pathologic_stage == "Stage III" ~ "3",
        ajcc_pathologic_stage == "Stage IIIA" ~ "3",
        ajcc_pathologic_stage == "Stage IIIB" ~ "3",
        ajcc_pathologic_stage == "Stage IIIC" ~ "3",
        ajcc_pathologic_stage == "Stage IV" ~ "4"
    )))

#Survival plot
sample_metadata |> 
    dplyr::filter(stage != "0") |> 
    survfit2(Surv(last_event, survial_censor) ~ stage , data = _) |>
    ggsurvfit() +
    add_risktable(risktable_stats = "n.risk") +
    add_pvalue()

```

